name: Customize Theme on Binary Update

on:
  push:
    paths:
      - 'assets/js/binary.js'
    branches:
      - main
      - master
  release:
    types: [created, published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  customize-theme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    # Skip if the commit was made by github-actions bot
    if: github.actor != 'github-actions[bot]'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 2  # Fetch last 2 commits to check previous changes
      
      - name: Check if already customized
        id: check_customized
        run: |
          if grep -q "Custom theme override injected by GitHub Action" assets/js/binary.js; then
            echo "already_customized=true" >> $GITHUB_OUTPUT
            echo "Binary.js already has custom theme applied, skipping..."
          else
            echo "already_customized=false" >> $GITHUB_OUTPUT
            echo "Binary.js needs customization"
          fi
      
      - name: Customize binary.js theme colors
        if: steps.check_customized.outputs.already_customized == 'false'
        run: |
          # Define color replacements
          # These patterns search for common default color values in the compiled binary
          
          # Replace common purple/default theme colors with custom teal theme
          # Pattern: Look for hex colors that match default arcade theme
          
          # Background: Replace black/dark backgrounds (already #000000, but ensure)
          sed -i 's/#2e2e2e/#000000/gi' assets/js/binary.js
          sed -i 's/#1a1a1a/#000000/gi' assets/js/binary.js
          
          # Button stroke: Replace white/light grays with #fffff0
          sed -i 's/#ffffff/#fffff0/gi' assets/js/binary.js
          sed -i 's/#f0f0f0/#fffff0/gi' assets/js/binary.js
          sed -i 's/#e0e0e0/#fffff0/gi' assets/js/binary.js
          
          # Button fill: Replace purple/blue theme colors with #418081 (teal)
          sed -i 's/#7b42bc/#418081/gi' assets/js/binary.js
          sed -i 's/#8b42bc/#418081/gi' assets/js/binary.js
          sed -i 's/#9b42bc/#418081/gi' assets/js/binary.js
          sed -i 's/#6633cc/#418081/gi' assets/js/binary.js
          sed -i 's/#663399/#418081/gi' assets/js/binary.js
          
          # Alternative approach: Search for CSS variable definitions
          # Replace the actual CSS variable values if they exist in the binary
          sed -i 's/--sim-background-color:[^;!}]*/--sim-background-color:#000000/gi' assets/js/binary.js
          sed -i 's/--sim-button-stroke:[^;!}]*/--sim-button-stroke:#fffff0/gi' assets/js/binary.js
          sed -i 's/--sim-button-fill:[^;!}]*/--sim-button-fill:#418081/gi' assets/js/binary.js
          sed -i 's/--sim-dpad-fill:[^;!}]*/--sim-dpad-fill:#fffff0/gi' assets/js/binary.js
          
          echo "Theme customization complete"
      
      - name: Remove .game-player-msft references
        if: steps.check_customized.outputs.already_customized == 'false'
        run: |
          # Try to find and neutralize game-player-msft class additions
          # This searches for patterns like 'game-player-msft' and replaces with 'game-player-hidden'
          sed -i 's/"game-player-msft"/"game-player-hidden"/g' assets/js/binary.js
          sed -i "s/'game-player-msft'/'game-player-hidden'/g" assets/js/binary.js
          
          echo ".game-player-msft references neutralized"
      
      - name: Inject custom style override
        if: steps.check_customized.outputs.already_customized == 'false'
        run: |
          # Add a style injection at the end of binary.js
          cat >> assets/js/binary.js << 'EOF'

// Custom theme override injected by GitHub Action
(function() {
    if (typeof document !== 'undefined') {
        var observer = new MutationObserver(function(mutations) {
            var wrap = document.getElementById('wrap');
            if (wrap && !wrap.hasAttribute('data-custom-theme')) {
                wrap.setAttribute('data-custom-theme', 'true');
                wrap.style.setProperty('--sim-background-color', '#000000', 'important');
                wrap.style.setProperty('--sim-button-stroke', '#fffff0', 'important');
                wrap.style.setProperty('--sim-button-fill', '#418081', 'important');
                wrap.style.setProperty('--sim-dpad-fill', '#fffff0', 'important');
            }
            // Hide game-player-msft
            var msft = document.querySelectorAll('.game-player-msft, .game-player-hidden');
            msft.forEach(function(el) { el.style.display = 'none'; });
        });
        if (document.body) {
            observer.observe(document.body, { childList: true, subtree: true });
        } else {
            document.addEventListener('DOMContentLoaded', function() {
                observer.observe(document.body, { childList: true, subtree: true });
            });
        }
    }
})();
EOF
          
          echo "Custom style override injected into binary.js"
      
      - name: Commit and push changes
        if: steps.check_customized.outputs.already_customized == 'false'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/js/binary.js
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Apply custom theme colors [automated]"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
