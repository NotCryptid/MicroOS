name: Customize Theme on Binary Update

on:
  push:
    paths:
      - 'assets/js/binary.js'
    branches:
      - main
      - master
  release:
    types: [created, published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  customize-theme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    # Skip if the commit was made by github-actions bot
    if: github.actor != 'github-actions[bot]'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: Check if already customized
        id: check_customized
        run: |
          if grep -q "Custom theme override injected by GitHub Action" assets/js/binary.js; then
            echo "already_customized=true" >> $GITHUB_OUTPUT
            echo "Binary.js already has custom theme applied, skipping..."
          else
            echo "already_customized=false" >> $GITHUB_OUTPUT
            echo "Binary.js needs customization"
          fi
      
      - name: Inject custom style override (non-destructive)
        if: steps.check_customized.outputs.already_customized == 'false'
        run: |
          cat >> assets/js/binary.js << 'ENDOFFILE'

          // Custom theme override injected by GitHub Action
          (function() {
              if (typeof document !== 'undefined') {
                  function applyCustomTheme() {
                      // Apply theme to #wrap element
                      var wrap = document.getElementById('wrap');
                      if (wrap && !wrap.hasAttribute('data-custom-theme')) {
                          wrap.setAttribute('data-custom-theme', 'true');
                          wrap.style.setProperty('--sim-background-color', '#000000', 'important');
                          wrap.style.setProperty('--sim-button-stroke', '#fffff0', 'important');
                          wrap.style.setProperty('--sim-button-fill', '#418081', 'important');
                          wrap.style.setProperty('--sim-dpad-fill', '#fffff0', 'important');
                      }
                      
                      // Hide game-player-msft elements
                      var msftElements = document.querySelectorAll('.game-player-msft');
                      msftElements.forEach(function(el) { 
                          el.style.display = 'none';
                          el.style.visibility = 'hidden';
                      });
                  }
                  
                  // Apply immediately if DOM is ready
                  if (document.readyState === 'loading') {
                      document.addEventListener('DOMContentLoaded', applyCustomTheme);
                  } else {
                      applyCustomTheme();
                  }
                  
                  // Watch for dynamic additions
                  var observer = new MutationObserver(function(mutations) {
                      applyCustomTheme();
                  });
                  
                  // Start observing once body is available
                  if (document.body) {
                      observer.observe(document.body, { childList: true, subtree: true });
                  } else {
                      document.addEventListener('DOMContentLoaded', function() {
                          observer.observe(document.body, { childList: true, subtree: true });
                      });
                  }
              }
          })();
          ENDOFFILE
          
          echo "Custom style override injected into binary.js"
      
      - name: Commit and push changes
        if: steps.check_customized.outputs.already_customized == 'false'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/js/binary.js
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Apply custom theme colors [automated]"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
